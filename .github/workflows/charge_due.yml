name: Daily Supabase Charge

on:
  schedule:
    - cron: '0 11 * * *'   # 11:00 UTC â‰ˆ 7:00 AM ET
  workflow_dispatch:        # allows manual runs from the Actions tab

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase Edge Function
        env:
          FUNCTION_URL: ${{ secrets.FUNCTION_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -e
          : "${FUNCTION_URL:?Missing FUNCTION_URL secret}"
          : "${CRON_TOKEN:?Missing CRON_TOKEN secret}"

          echo "Calling $FUNCTION_URL ..."
          # Call the function, capture status, headers, and body
          HTTP_STATUS=$(curl --fail --show-error -s -X POST \
            "$FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -d "{\"cron_token\":\"${CRON_TOKEN}\"}" \
            -D headers.txt \
            -o response.json \
            -w "%{http_code}")

          echo "HTTP status: $HTTP_STATUS"
          echo "Response headers:"
          sed -e 's/\r$//' headers.txt | tail -n +1

          echo "Response body:"
          cat response.json || true
